<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Login Success</title>
  </head>
  <body>
    <h3>Login successful. You can close this tab.</h3>

    <script>
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      const userRaw = params.get("user");

      let user = null;
      try {
        user = userRaw ? JSON.parse(decodeURIComponent(userRaw)) : null;
      } catch (e) {
        user = null;
      }

      // âœ… Do NOT hardcode extension id.
      // Send to any installed extension that listens to externally_connectable.
      const msg = { type: "LOGINSUCCESS", token, user };

      // Try common ids if available, otherwise fallback to postMessage pattern.
      // Best: backend should redirect to chrome-extension://<EXT_ID>/auth-success.html
      // But if it's hosted on your domain, we can only use runtime messaging by id.
      // So: store extensionId in localStorage on first open from extension.
      const extId = localStorage.getItem("SMART_POMODORO_EXT_ID");

      if (extId) {
        chrome.runtime.sendMessage(extId, msg, () => window.close());
      } else {
        // If extId missing, show instruction
        document.body.innerHTML =
          "<h3>Login saved, but extension id not found.</h3>" +
          "<p>Please open the extension popup once and click Login again.</p>";
      }
    </script>
  </body>
</html>
